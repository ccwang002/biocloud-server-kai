{% extends 'experiments/base.html' %}

{% load crispy_forms_tags static %}

{% block title %}New experiment{% endblock title %}

{% block extra_css %}
	{{ block.super }}
	{{ form.media.css }}
{% endblock extra_css %}

{% block content %}
	<h2>New experiement</h2>
	{% crispy form %}
	<div id="app">
		<h2>Conditions</h2>
		<div v-show="editable">
			<button v-on:click="leaveEditMode()" class="btn btn-danger">Leave Edit Mode</button>
			<ol>
				<li v-for="(index, condition) in conditions" track-by="_uid">
					<input type="text" v-model="condition.label">
					<button v-on:click="removeCondition(index, $event)" class="btn btn-xs btn-danger">Remove</button>
				</li>
				<li class="list-unstyled">
					<button v-on:click="addCondition()" class="btn btn-default">Add Condition</button>
				</li>
			</ol>
		</div>
		<div v-show="!editable">
			<button v-on:click="enterEditMode()" class="btn btn-success">Edit Condition</button>
			{% verbatim %}
			<ol class="list-inline">
				<li v-for="(index, condition) in conditions" track-by="_uid">{{ index + 1 }}. {{ condition.label }}</li>
			</ol>
			{% endverbatim %}
		</div>

		<h2>Group Sources as Samples</h2>
		<button v-on:click="updateFilteredSourcesSelectedStatus(true)" class="btn btn-default">Select all</button>
		<button v-on:click="updateFilteredSourcesSelectedStatus(false)" class="btn btn-default">Unselect all</button>
		<button v-on:click="clearAllFilters" class="btn btn-default">Clear all filters</button>
		<table class="table table-striped">
			<thead>
			<tr>
				<th></th>
				<th>File path</th>
				<th>File type</th>
				<th>Sample</th>
				<th>Strand</th>
			</tr>
			<tr>
				<td></td>
				<td><input type="text" v-model="sourceFilter.filePath" debounce="300"></td>
				<td><input type="text" v-model="sourceFilter.fileType" debounce="300"></td>
				<td><input type="text" v-model="sourceFilter.sample" debounce="300"></td>
				<td></td>
			</tr>
			</thead>
			<tbody>
			{% verbatim %}
			<tr v-for="(index, source) in filteredDataSources" track-by="data_source_pk">
				<td><input type="checkbox" v-model="source.selected"></td>
				<td>{{ source.file_path }}</td>
				<td>{{ source.file_type }}</td>
				<td><input type="text" v-model="source.sample"></td>
				<td><input type="text" v-model="source.metadata.strand"></td>
			</tr>
			{% endverbatim %}
			</tbody>
		</table>
		<p>
			Rename filtered sources' sample name to
			<input type="text"
						 v-model="newSampleName"
						 v-on:keyup.Enter="renameFilteredSourcesName"
						 v-bind="{disabled: !canRenameSample}">
			<button v-on:click="renameFilteredSourcesName"
							class="btn btn-default btn-sm"
							v-bind="{disabled: !canRenameSample}"
			>Rename</button>
		</p>


		<h2>Group Samples as Conditions</h2>
		<table class="table table-striped">
			<thead>
			<tr>
				<th>Sample</th>
				<th>Condition</th>
				<th>Included files</th>
			</tr>
			</thead>
			<tbody>
			{% verbatim %}
			<tr v-for="(index, sourcesBySample) in dataSourcesBySample" track-by="sample">
				<td>{{ sourcesBySample.sample }}</td>
				<td>
					<select
							v-model="sourcesBySample.condition"
							v-on:change="updateSourceCondition(sourcesBySample.sample, sourcesBySample.condition)"
					>
						<option v-for="condition in conditions" v-bind:value="condition._uid">
							{{ condition.label }}
						</option>
					</select>
				</td>
				<td>
					<span v-for="file in sourcesBySample.files" class="source-label">{{
						file.label }}</span>
				</td>
			</tr>
			{% endverbatim %}
			</tbody>
		</table>
	</div><!-- /#app -->
{% endblock content %}

{% block extra_js %}
	{{ block.super }}
	<script src="{% static 'js/vendors/vue.min.js' %}"></script>
	{{ form.media.js }}
{% endblock extra_js %}

{% block scripts %}
	<script>
		var vueAppData = {
			// states we need to keep across POST/GET forms
			conditions: [
			],
			numConditionCreated: 0,
			dataSources: {{ data_source_json }},
			// states only needed for editing
			editable: true,
			sourceFilter: {
				filePath: '',
				fileType: '',
				sample: ''
			},
			newSampleName: ''
		};
// 		var data_sources = [
// 			{
// 				'data_source_pk': "1",
// 				'file_path': "sample_R1.fastq",
// 				'file_type': "FASTQ",
// 				'sample': "sample",
// 				'metadata': {
// 					"paired": true,
// 					"strand": "1"
// 				},
// 				"condition": undefined,
// 				"selected": false,
// 			},
// 			{
// 				'data_source_pk': "2",
// 				'file_path': "sample_R2.fastq",
// 				'file_type': "FASTQ",
// 				'sample': "sample",
// 				'metadata': {
// 					"paired": true,
// 					"strand": "2"
// 				},
// 				"condition": undefined,
// 				"selected": false,
// 			},
// 			{
// 				'data_source_pk': "3",
// 				'file_path': "another_R1.fastq",
// 				'file_type': "FASTQ",
// 				'sample': "another",
// 				'metadata': {},
// 				"condition": undefined,
// 				"selected": false,
// 			},
// 			{
// 				'data_source_pk': "4",
// 				'file_path': "another_R2.fastq",
// 				'file_type': "FASTQ",
// 				'sample': "another",
// 				'metadata': {},
// 				"condition": undefined,
// 				"selected": false,
// 			},
//             			{
// 				'data_source_pk': "5",
// 				'file_path': "yet_another_R1.fastq",
// 				'file_type': "FASTQ",
// 				'sample': "yet_another",
// 				'metadata': {},
// 				"condition": undefined,
// 				"selected": false,
// 			},
// 			{
// 				'data_source_pk': "6",
// 				'file_path': "yet_another_R2.fastq",
// 				'file_type': "FASTQ",
// 				'sample': "yet_another",
// 				'metadata': {},
// 				"condition": undefined,
// 				"selected": false,
// 			}
// 		];
	</script>
	<script src="{% static 'js/experiements/manage_conditions.js' %}"></script>
{% endblock scripts %}

